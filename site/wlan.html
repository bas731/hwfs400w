<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta http-equiv="Content-Type"    content="text/html; charset=UTF-8">
	<link href="../style/generic.css" rel="stylesheet" type="text/css" title="Plain">
	<title>Mustek S400W iScan Air Wifi How-To</title>
</head>
<body>

<a href="index.html">Back</a>

<h1 class="first">Mustek S400W iScan Air Wifi How-To</h1>
I am running debian. So apt-get will appear in this document. Your mileage may vary.
Resoures used:<ul>
	<li>/usr/share/doc/wpasupplicant/README.Debian.gz
	<li>https://ubuntuforums.org/showthread.php?t=1259003
	<li>https://manual.siduction.org/inet-wpa
	<li>https://unix.stackexchange.com/questions/182967/can-i-prevent-a-default-route-being-added-when-bringing-up-an-interface
</ul>

<h2>Prerequisites</h2>

<h3>Hardware</h3>

<p>
If your board has an internal free PCIe or mini-PCIe slot, you can us this, otherwise just get a cheap wlan stick.
In any case you'll need 802.11n, WPA2 capability, and linux support.
<p>

<h3>Software</h3>
<ul>
<li>You'll probably need firmwares (adjust /etc/apt/sources.lst to main non-free contrib):<br>
	<kbd>apt-get install firmware-linux firmware-linux-free firmware-linux-nonfree firmware-ralink</kbd>
<li>We need wpasupplicant:<br>
	<kbd>apt-get install wpasupplicant</kbd>
<li>Might also come in handy:<br>
	<kbd>apt-get install wireless-tools ifupdown</kbd>
</ul>


<p>Avoid endless waiting at boot:<br>
<kbd>mkdir /etc/systemd/system/networking.service.d</kbd><br>
<kbd>edit /etc/systemd/system/networking.service.d/reduce-timeout.conf</kbd><br>
<code class="block">[Service]
TimeoutStartSec=60 # or 30
</code></p>

<p>DHCP is necessary so if you don't have one: <kbd>apt-get install dhclient</kbd><br>
<code>/etc/dhcp/dhclient.conf</code> should not have interface entries if you can avoid it
(they will be renewed when our wlan connects, not really problem, just annoying).
</p>

<p>If you have dhcp running with a router and you have no resolvconf package installed, you might want to protected
<code>/etc/resolv.conf</code>:<br>
<kbd>chmod +i /etc/resolv.conf</kbd><br>
If your dhcp client can be configured to not overwrite it, then you don't need it.</p>

<p>If you have or want (<kbd>apt-get install resolvconf</kbd>) to use resolvconf:<br>
<kbd>edit /etc/resolvconf/interface-order</kbd><br>
and make sure that wlan entries comes after eth.<br>
(If you have a bridge setup, e.g. you have more than ethernet port and
use it as switch, don't forget to add a <code>br*</code> wildcard).</p>

<h2>Connecting to the scanner with wpa_supplicant</h2>

<p>Ok, dhcp and resolving is set up, lets get started with wpa!<p>
<p>What we want is to detect a turned on scanner within 30 seconds and if it is turned off, notice that fairly quickly, too.
So that interfaces and dhcp leases can be removed (dhcp lease time is rather big, but needs to be redone every time
we connect to the scanner). The older tutorial did this all by hand, but debian has support for this built in
(and probably most other distro): <em>wifi roaming!</em>
I'll append the old script at the end, but it never worked as well as the inbuilt stuff.</p>

<p>Note: This documentation assumes our wlan is <code>wlan0</code></p>

<h3>Roaming wpa_supplicant.conf</h3>

<p>Create <code>/etc/wpa_supplicant/wpa_supplicant.conf</code> if not already there, and edit it.<br>
Alter the ssid to match your <code>DIRECT-&lt;6 digits&gt;-&lt;AirCopy|iScanAir|etc&gt;</code> and set the correct country:</p>
<code class="block"># "roaming" config for mustek s400w scanner
update_config=1
ctrl_interface=DIR=/run/wpa_supplicant GROUP=netdev
country=DE
fast_reauth=1
eapol_version=1
ap_scan=1
filter_ssids=1
autoscan=periodic:30
network={
	id_str="s400w"
	ssid="DIRECT-ABCDEF_AirCopy"
	proto=WPA2
	psk="12345678"
	ap_max_inactivity=20
	key_mgmt=WPA-PSK
	pairwise=CCMP
	group=CCMP
	#disabled=1
}
</code>

<p>Protect it: <kbd>chmod 0600 /etc/wpa_supplicant/wpa_supplicant.conf</kbd></p>

<h3>network/interfaces</h3>

<p><kbd>edit /etc/network/interfaces</kbd> and add the following (choose the right driver):</p>
<code class="block">allow-hotplug wlan0
iface wlan0 inet manual
	wpa-driver  nl80211,wext
	wpa-roam    /etc/wpa_supplicant/wpa_supplicant.conf

iface s400w inet dhcp
</code>

<p>Protect it: <kbd>chmod 0600 /etc/network/interfaces</kbd></p>

<p>restart networking and ifup / down wlan0, maybe reboot:<br>
<kbd class="block">ifdown wlan0
/etc/init.d/networking restart
ifup wlan0
</kbd>
</p>

<h3>Routes</h3>

<p>Problem 1: <code>wlan0</code> must not overwrite our default route.<br>
A solution for dhclient is to create a file in <code>/etc/dhcp/dhclient-enter-hooks.d</code>:<br>
<kbd>edit /etc/dhcp/dhclient-enter-hooks.d/s400w</kbd>:</p>
<code class="block">#!/bin/sh
## prevent DHCP server on wlan0 from forcing a default route on us
case "${reason}.${interface}" in
	RENEW.wlan0|BOUND.wlan0)
		ip route delete default via $new_routers
		#new_routers = ""
		;;
	*)
		;;
esac
</code>

<p><kbd>chmod 0644 /etc/dhcp/dhclient-enter-hooks.d/s400w</kbd></p>


<h3>Firewall</h3>

<p>Problem 2: if somebody fakes being the scanner, the system will happily connect to it and make it vulnerable.
If you don't have a firewall already, you can use:</p>
<kbd class="block">iptables -o wlan0 -A OUTPUT -p all -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
iptables -i wlan0 -A INPUT  -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
iptables -i wlan0 -A INPUT  -m conntrack --ctstate INVALID -j DROP
iptables -i wlan0 -A INPUT  -p udp -j REJECT --reject-with icmp-port-unreachable
iptables -i wlan0 -A INPUT  -p tcp -j REJECT --reject-with tcp-reset
iptables -i wlan0 -A INPUT  -j REJECT --reject-with icmp-proto-unreachable
</kbd>

<p>Save it: <kbd>iptables-save &gt;/etc/iptables.s400w.rules</kbd></p>

<p><kbd>edit /etc/rc.local</kbd> and add</p>
<code class="block">/sbin/iptables-restore &lt; /etc/iptables.s400w.rules</code>

<br>
<hr>

<h2>Old stuff</h2>

<p>We assume our wlan is wlan0.</p>

<p><kbd>edit /etc/network/interfaces</kbd>, add and edit the ssid to match your DIRECT-&lt;6 digits&gt;-&lt;AirCopy|iScanAir|etc&gt;:</p>
<code class="block">auto wlan0
allow-hotplug wlan0
iface wlan0 inet static
		address         192.168.18.1
		network         192.168.18.0
		netmask         255.255.255.0
		broadcast       192.168.18.255
		wpa-ssid        DIRECT-ABCDEF_AirCopy
		wpa-psk         "12345678"
</code>

<p>Those static values are dummies, but dhcp will not be able to overwrite them,
so they must match dhcp response (should, if no other client is connected to the scanner,
sometimes <code>192.168.18.2</code> will appear, then we are in trouble)</p>

<p>Protect it: <kbd>chmod 600 /etc/network/interfaces</kbd>

<p>Now we need to start dhclient for <code>wlan0</code> on connect and kill it on disconnect.<p>
<p>Create file <code>/etc/dhcp/dhclient.wpa_cli.sh</code>
<code class="block">#!/bin/bash
PID=/var/run/dhclient.$1.pid
LEASES=/var/lib/dhcp/dhclient.$1.leases
logger -s -p local0.info -t dhclient.wpa_cli.sh $1 $2
case "$1.$2" in
	wlan0.CONNECTED )
		if [ -f $PID  ]; then kill `cat $PID`; fi
		rm $LEASES
		dhclient -v -pf $PID -lf $LEASES $1
		;;
	wlan0.DISCONNECTED )
		if [ -f $PID  ]; then kill `cat $PID`; fi
		rm $LEASES
		;;
	* )
		echo called with $1.$2
		;;
esac
</code>

<p>Make it executable? <kbd>chmod 755 /etc/dhcp/dhclient.wpa_cli.sh</kbd></p>

<p>Edit your <code>/etc/rc.local</code> and add near the end before <code>exit 0</code>:
<code>wpa_cli -B -a /etc/dhcp/dhclient.wpa_cli.sh</code></p>

<p>Now <code>wpa_supplicant</code> will start / kill dhclient for <code>wlan0</code></p>

<h3>CAVEATS</h3>
<p><code>wpa_supplicant</code> will exit if you <kbd>ifdown wlan0</kbd>. Don't down it. Or wrap the supplicant call into a loop.</p>

<p>You might want to install <code>iptables</code> and block any incomming traffic from <code>wlan0</code> that is not
a response to outgoing traffic. This will block attacks with spoofed AP using the SSID and well known password!</p>

</body>
</html>
